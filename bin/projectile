#!/usr/bin/env bash
# vim: ft=bash

pattern="$1"
if [[ -z "$pattern" ]]; then
    echo "usage: $0 <pattern>"; tree -L 3 -d "$HOME/repos" "$HOME/personal"; exit 1
fi

matched=$(tmux list-sessions 2>/dev/null | grep "$pattern")
if [ -z "$matched" ]; then
    dir="$(find $HOME/repos $HOME/personal -maxdepth 3 -type d -iname "$pattern*" | head -n 1)"
    if [ -z "${dir}" ]; then
        tmux display-message "no project found matching '$pattern'"; exit 0
    fi

    name=$(basename "$dir")
    if ! tmux has-session -t "$name" 2>/dev/null; then
        tmux new-session -s "$name" -d -c "$dir"
    fi
    tmux switch-client -t "$name"; exit 0
fi

session_name=$(echo "$matched" | head -n1 | cut -d: -f1)
tmux switch -t "$session_name"; exit 0
