#!/usr/bin/env bash
# vim: ft=bash
set -euo pipefail

readonly XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
readonly XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
readonly ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

create_directories() {
    echo 'creating essential files/directories'
    mkdir -p "$XDG_DATA_HOME"
    mkdir -p "$XDG_CONFIG_HOME"
    mkdir -p "$HOME/personal"
    mkdir -p "$HOME/repos"
}

link_dotfiles() {
    echo 'linking dotfiles'

    local -a dotfiles=(
        ghostty
        fish
        nvim
        .tmux.conf
        .psqlrc
        .ripgreprc
        .gitignore
    )

    for file in "${dotfiles[@]}"; do
        if [[ -d "$ROOT_DIR/$file" ]]; then
            ln -sfn "$ROOT_DIR/$file" "$XDG_CONFIG_HOME/$file"
        elif [[ -f "$ROOT_DIR/$file" ]]; then
            ln -sfn "$ROOT_DIR/$file" "$HOME/$file"
        else
            echo "file not found: $ROOT_DIR/$file" >&2
        fi
    done
}

configure_git() {
    echo 'configuring git'
    git config --global core.excludesFile "$HOME/.gitignore"
    git config --global pull.rebase true
    git config --global merge.tool nvimdiff2
    git config --global diff.tool nvimdiff2
}

setup_macos() {
    if ! xcode-select -p &> /dev/null; then
        echo 'installing xcode command line tools'
        xcode-select --install
    fi

    if ! command -v brew &> /dev/null; then
        echo "installing homebrew"
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        # (echo; echo "/opt/homebrew/bin/brew shellenv | source") >> "$XDG_CONFIG_HOME/fish/conf.d/custom.fish"
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi

    echo 'installing essential packages'
    brew update

    local -a packages=(
        curl wget git fish coreutils watch cmake ninja
        ghostty tmux tree ncdu ripgrep jq parallel gdb
    )
    brew install "${packages[@]}"
}

build_from_source() {
    local name="$1"
    local target_dir="$HOME/personal/$name"
    local repo_url="$2"
    local build_commands="$3"

    echo "building $name from source"
    if [[ !  -d "$target_dir" ]]; then
        git clone --depth 1 "$repo_url" "$target_dir"
    else
        echo "$name already cloned, updating..."
        git -C "$target_dir" pull --rebase
    fi

    (
        cd "$target_dir"
        eval "$build_commands"
    )
}

setup_linux() {
    echo 'installing essential packages'
    sudo apt-get update && sudo apt-get upgrade -y

    local -a packages=(
        curl wget zip git fish coreutils gcc clang clangd cmake make ninja-build
        watch tree vim tmux gdb ripgrep ncdu parallel jq xxd wl-clipboard
    )
    sudo apt-get install -y "${packages[@]}"

    # most convenient way for now, since ghostty doesn't use latest zig
    # might be updated in the future
    sudo snap install ghostty --classic

    echo 'disable dash to dock hot-keys on ubuntu'
    gsettings set org.gnome.shell.extensions.dash-to-dock hot-keys false
}

install_neovim() {
    build_from_source 'neovim' \
        'https://github.com/neovim/neovim.git' \
        'make distclean && make CMAKE_BUILD_TYPE=RelWithDebInfo && sudo make install'
}

configure_shell() {
    if [[ "$SHELL" == */fish ]]; then
        echo 'default shell is already fish'
        return 0
    fi

    echo 'changing default shell to fish'
    local fish_path=$(command -v fish)
    if [[ -z "$fish_path" ]]; then
        echo 'fish not found in path' >&2
        return 1
    fi

    if ! grep -q "^$fish_path$" /etc/shells; then
        echo "adding $fish_path to /etc/shells"
        echo "$fish_path" | sudo tee -a /etc/shells
    fi

    chsh -s "$fish_path"
    echo 'please log out and log back in for shell change to take effect'
}

main() {
    create_directories
    link_dotfiles
    configure_git
    if [[ "$(uname -s)" == 'Darwin' ]]; then
        setup_macos
    else
        setup_linux
    fi
    install_neovim
    configure_shell
}

main "$@"
